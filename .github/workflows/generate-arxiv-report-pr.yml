name: Generate ArXiv Paper Report (PR)

on:
  workflow_dispatch:
    inputs:
      arxiv_url:
        description: 'ArXiv paper URL (e.g., https://arxiv.org/abs/2410.20672)'
        required: true
        type: string
      language:
        description: 'Report language'
        required: false
        default: 'English'
        type: choice
        options:
          - 'English'
          - 'Traditional Chinese'
      mode:
        description: 'Report mode'
        required: false
        default: 'simple'
        type: choice
        options:
          - 'simple'
          - 'detailed'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-report-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        set -e
        echo "ðŸ“¦ Installing system dependencies..."
        sudo apt-get update || {
          echo "âŒ Failed to update package lists"
          exit 1
        }
        
        echo "ðŸ“‹ Installing required packages..."
        sudo apt-get install -y \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libx11-xcb-dev \
          libxcb-glx0-dev \
          libxcb-render0-dev \
          libxcb-render-util0-dev \
          libxcb-shape0-dev \
          libxcb-randr0-dev \
          libxcb-image0-dev \
          libxcb-shm0-dev \
          libxcb-xfixes0-dev \
          wkhtmltopdf \
          poppler-utils \
          tesseract-ocr \
          fonts-noto-cjk || {
          echo "âŒ Failed to install system dependencies"
          exit 1
        }
        
        echo "âœ… System dependencies installed successfully"
        echo "ðŸ” Verifying key dependencies:"
        wkhtmltopdf --version || echo "âš ï¸  wkhtmltopdf not found"
        pdfinfo -v || echo "âš ï¸  pdfinfo not found"
        pdftoppm -h > /dev/null 2>&1 || echo "âš ï¸  pdftoppm not found"
        tesseract --version || echo "âš ï¸  tesseract not found"
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      run: |
        set -e
        if [ "${{ steps.cached-poetry-dependencies.outputs.cache-hit }}" = "true" ]; then
          echo "ðŸ“¦ Using cached Python dependencies..."
          echo "âœ… Cache hit - verifying installation"
          poetry show --tree || poetry show || {
            echo "âš ï¸  Cache seems corrupted, reinstalling..."
            poetry install || {
              echo "âŒ Failed to install dependencies after cache corruption"
              exit 1
            }
          }
        else
          echo "ðŸ“¦ Installing Python dependencies..."
          echo "ðŸ” Cache miss - installing fresh dependencies"
          make install || {
            echo "âŒ Failed to install dependencies via make install"
            echo "ðŸ” Trying direct poetry install..."
            poetry install || {
              echo "âŒ Poetry install also failed"
              echo "ðŸ“‹ Poetry environment info:"
              poetry env info
              echo "ðŸ“‹ Poetry show (if available):"
              poetry show || echo "Could not show installed packages"
              exit 1
            }
          }
        fi
        echo "âœ… Dependencies ready"
        echo "ðŸ“‹ Installed packages:"
        poetry show --tree || poetry show
        
        echo "ðŸ“¦ Downloading NLTK resources..."
        poetry run python -c "import nltk; import ssl; import os; ssl._create_default_https_context = ssl._create_unverified_context; nltk_data_dir = os.path.expanduser('~/.local/share/nltk_data'); os.makedirs(nltk_data_dir, exist_ok=True); nltk.data.path.append(nltk_data_dir); [nltk.download(pkg, download_dir=nltk_data_dir, quiet=True) for pkg in ['punkt', 'punkt_tab', 'averaged_perceptron_tagger', 'stopwords']]; print('âœ… NLTK resources downloaded successfully')" || {
          echo "âŒ Failed to download NLTK resources"
          exit 1
        }
    
    - name: Set up environment variables
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}" >> $GITHUB_ENV
    
    - name: Generate report
      id: generate
      run: |
        set -e
        set -x
        
        echo "ðŸš€ Starting ArXiv report generation..."
        echo "ðŸ“‹ Input parameters:"
        echo "   ðŸ“„ ArXiv URL: ${{ inputs.arxiv_url }}"
        echo "   ðŸŒ Language: ${{ inputs.language }}"
        echo "   âš™ï¸  Mode: ${{ inputs.mode }}"
        echo "   ðŸ Python version: $(python --version)"
        echo "   ðŸ“¦ Poetry version: $(poetry --version)"
        
        echo "ðŸ” Environment check:"
        echo "   ðŸ”‘ OpenAI API key set: $([ -n "$OPENAI_API_KEY" ] && echo "âœ… Yes" || echo "âŒ No")"
        echo "   ðŸŒ OpenAI base URL: ${OPENAI_BASE_URL:-"Default"}"
        echo "   ðŸ’¾ Available disk space: $(df -h . | tail -1 | awk '{print $4}')"
        
        echo "ðŸ“ Current working directory: $(pwd)"
        echo "ðŸ“‹ Directory contents:"
        ls -la
        
        echo "ðŸš€ Executing report generation..."
        poetry run python scripts/generate_single_report.py "${{ inputs.arxiv_url }}" --language "${{ inputs.language }}" --mode "${{ inputs.mode }}" || {
          echo "ðŸ’¥ Report generation failed with exit code $?"
          echo "ðŸ” Checking for any generated files..."
          find . -name "*.pdf" -type f -newer /tmp -ls 2>/dev/null || echo "No PDF files found"
          find papers/ -type f -ls 2>/dev/null || echo "No files found in papers directory"
          echo "ðŸ“‹ Final directory contents:"
          ls -la papers/ 2>/dev/null || echo "Papers directory not found"
          exit 1
        }
        
        echo "âœ… Report generation completed successfully"
        
        ARXIV_ID=$(echo "${{ inputs.arxiv_url }}" | sed 's/.*\///')
        echo "report_id=${ARXIV_ID}" >> $GITHUB_OUTPUT
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Create branch and commit report
      id: create_branch
      run: |
        set -e
        echo "ðŸ“‹ Checking for generated files to commit..."
        
        if [ ! -d "papers/" ]; then
          echo "âŒ Papers directory not found!"
          exit 1
        fi
        
        echo "ðŸ“ Papers directory contents:"
        find papers/ -type f -ls || echo "No files found in papers directory"
        
        BRANCH_NAME="arxiv-report-${{ steps.generate.outputs.report_id }}-$(date +%Y%m%d-%H%M%S)"
        echo "ðŸŒ± Creating new branch: ${BRANCH_NAME}"
        git checkout -b "${BRANCH_NAME}" || {
          echo "âŒ Failed to create branch ${BRANCH_NAME}"
          exit 1
        }
        
        echo "ðŸ“ Adding files to git..."
        git add papers/ || {
          echo "âŒ Failed to add papers directory to git"
          exit 1
        }
        
        echo "ðŸ” Checking for changes to commit..."
        if git diff --staged --quiet; then
          echo "âš ï¸  No changes to commit - this might indicate an issue with report generation"
          echo "ðŸ“‹ Git status:"
          git status
          exit 1
        else
          echo "âœ… Changes detected, proceeding with commit..."
          echo "ðŸ“‹ Files to be committed:"
          git diff --staged --name-only
          
          echo "ðŸ“ Committing changes..."
          git commit -m "Add arXiv paper report: ${{ inputs.arxiv_url }}" \
                     -m "Generated report for arXiv paper: ${{ inputs.arxiv_url }}" \
                     -m "Language: ${{ inputs.language }}" \
                     -m "Mode: ${{ inputs.mode }}" \
                     -m "Generated at: $(date)" || {
            echo "âŒ Failed to commit changes"
            echo "ðŸ“‹ Git status:"
            git status
            exit 1
          }
          
          echo "ðŸš€ Pushing branch to repository..."
          git push origin "${BRANCH_NAME}" || {
            echo "âŒ Failed to push branch to repository"
            echo "ðŸ“‹ Git log (last 3 commits):"
            git log --oneline -3
            exit 1
          }
          
          echo "âœ… Branch created and pushed successfully"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Pull Request
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        set -e
        echo "ðŸ”„ Creating Pull Request..."
        
        # Create PR body content using echo
        echo "## ðŸ“„ ArXiv Paper Report" > pr_body.md
        echo "" >> pr_body.md
        echo "**Paper URL:** ${{ inputs.arxiv_url }}" >> pr_body.md
        echo "**Language:** ${{ inputs.language }}" >> pr_body.md
        echo "**Mode:** ${{ inputs.mode }}" >> pr_body.md
        echo "**Generated at:** $(date)" >> pr_body.md
        echo "" >> pr_body.md
        echo "---" >> pr_body.md
        echo "" >> pr_body.md
        echo "### ðŸ“‹ Summary" >> pr_body.md
        echo "This PR adds a new ArXiv paper report generated automatically via GitHub Actions." >> pr_body.md
        echo "" >> pr_body.md
        echo "### ðŸ” What's included" >> pr_body.md
        echo "- Generated paper summary and analysis" >> pr_body.md
        echo "- PDF report (if applicable)" >> pr_body.md
        echo "- Structured data files" >> pr_body.md
        echo "" >> pr_body.md
        echo "### âœ… Review checklist" >> pr_body.md
        echo "- [ ] Report content is accurate and complete" >> pr_body.md
        echo "- [ ] File structure follows project conventions" >> pr_body.md
        echo "- [ ] No sensitive information is exposed" >> pr_body.md
        echo "" >> pr_body.md
        echo "---" >> pr_body.md
        echo "" >> pr_body.md
        echo "*This PR was automatically generated by the \`generate-arxiv-report-pr\` workflow.*" >> pr_body.md
        
        # Create PR using GitHub CLI with body from file
        gh pr create \
          --title "ðŸ“„ Add ArXiv Paper Report: ${{ steps.generate.outputs.report_id }}" \
          --body-file pr_body.md \
          --head "${{ steps.create_branch.outputs.branch_name }}" \
          --base "main" \
          --label "arxiv-paper-report" \
          --reviewer "${{ github.actor }}" || {
          echo "âŒ Failed to create PR"
          echo "ðŸ“‹ Available branches:"
          git branch -a
          exit 1
        }
        
        echo "âœ… Pull Request created successfully"

    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-report-pr-${{ github.run_number }}
        path: papers/
        retention-days: 30

    - name: Summary
      run: |
        echo "## ðŸ“„ ArXiv Paper Report Generated (PR Created)!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Paper URL:** ${{ inputs.arxiv_url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Language:** ${{ inputs.language }}" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ steps.create_branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Generated Report:** \`${{ steps.generate.outputs.report_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ **A Pull Request has been created for review before merging to main branch.**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The report has been committed to a feature branch and is also available as an artifact." >> $GITHUB_STEP_SUMMARY
        echo "Please review the PR before merging to ensure quality and accuracy." >> $GITHUB_STEP_SUMMARY
